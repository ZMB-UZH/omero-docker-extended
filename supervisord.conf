[unix_http_server]
file=/tmp/supervisor.sock

[supervisord]
nodaemon=true
logfile=/opt/omero/web/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=5
pidfile=/tmp/supervisord.pid

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock

[program:omero-web]
command=/bin/bash -lc 'set -euo pipefail; venv_dir=""; if [[ -n "${OMERO_WEB_VENV:-}" ]]; then venv_dir="/opt/omero/web/${OMERO_WEB_VENV}"; else venv_dir="$(ls -d /opt/omero/web/venv* 2>/dev/null | sort -V | tail -n 1)"; fi; if [[ -z "${venv_dir}" || ! -x "${venv_dir}/bin/python" ]]; then echo "ERROR: Could not find OMERO.web venv under /opt/omero/web (OMERO_WEB_VENV=${OMERO_WEB_VENV:-unset})" >&2; ls -la /opt/omero/web >&2 || true; exit 1; fi; source "${venv_dir}/bin/activate"; exec omero web start --foreground'
directory=/opt/omero/web/OMERO.web
autostart=true
autorestart=true
stderr_logfile=/opt/omero/web/OMERO.web/var/log/omero-web.stderr.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=3
stdout_logfile=/opt/omero/web/OMERO.web/var/log/omero-web.stdout.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3

[program:imaris-celery-worker]
command=/opt/omero/web/bin/start-imaris-celery-worker.sh
directory=/opt/omero/web/OMERO.web
autostart=true
autorestart=unexpected
exitcodes=0
startretries=3
stderr_logfile=/opt/omero/web/OMERO.web/var/log/imaris-celery-worker.stderr.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=3
stdout_logfile=/opt/omero/web/OMERO.web/var/log/imaris-celery-worker.stdout.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3

[program:storage-quota-reconcile-loop]
command=/opt/omero/web/bin/storage-quota-reconcile-loop.sh
directory=/opt/omero/web/OMERO.web
autostart=true
autorestart=true
stderr_logfile=/opt/omero/web/OMERO.web/var/log/storage-quota-reconcile.stderr.log
stderr_logfile_maxbytes=20MB
stderr_logfile_backups=3
stdout_logfile=/opt/omero/web/OMERO.web/var/log/storage-quota-reconcile.stdout.log
stdout_logfile_maxbytes=20MB
stdout_logfile_backups=3
